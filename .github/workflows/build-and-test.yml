name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        os: ['ubuntu-24.04', 'ubuntu-24.04-arm']

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install required dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential cmake pkg-config \
          libboost-context-dev libboost-fiber-dev libboost-system-dev \
          libelf-dev libzmq3-dev

    - name: Install compression libraries
      run: |
        sudo apt-get install -y \
          libbz2-dev liblzo2-dev libzstd-dev liblz4-dev \
          zlib1g-dev liblzma-dev libbrotli-dev libsnappy-dev libblosc2-dev

    - name: Install HDF5 support
      run: |
        sudo apt-get install -y libhdf5-dev

    - name: Install MPI support
      run: |
        sudo apt-get install -y libmpich-dev

    - name: Install Catch2 testing framework
      run: |
        sudo apt-get install -y catch2 || echo "Using bundled Catch2 from submodules"

    - name: Install additional dependencies
      run: |
        sudo apt-get install -y \
          libssl-dev \
          doxygen \
          perl

    - name: Show system information
      run: |
        echo "=== System Information ==="
        uname -a
        echo ""
        echo "=== CPU Information ==="
        lscpu | grep -E "Architecture|CPU|Model name|Thread|Core"
        echo ""
        echo "=== Compiler Information ==="
        gcc --version
        g++ --version
        cmake --version
        echo ""
        echo "=== Dependency Versions ==="
        dpkg -l | grep -E "libboost|libzmq|libhdf5|libmpich" || true

    - name: Configure with CMake preset (debug)
      run: |
        cmake --preset=debug \
          -DWRP_CORE_ENABLE_RUNTIME=ON \
          -DWRP_CORE_ENABLE_CTE=ON \
          -DWRP_CORE_ENABLE_CAE=ON \
          -DWRP_CORE_ENABLE_CEE=ON \
          -DWRP_CORE_ENABLE_TESTS=ON
      env:
        CC: gcc
        CXX: g++

    - name: Build all components
      run: |
        cmake --build build --parallel $(nproc)
      timeout-minutes: 60

    - name: Show build artifacts
      run: |
        echo "=== Build directory structure ==="
        find build -name "*.so" -o -name "*.a" -o -name "*_test" | head -50
        echo ""
        echo "=== Build size ==="
        du -sh build/

    - name: Run tests
      run: |
        cd build
        ctest -VV --output-on-failure --timeout 300
      timeout-minutes: 20
      continue-on-error: false

    - name: Upload test results on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.os }}
        path: |
          build/Testing/
          build/**/*_test.log
        retention-days: 7

    - name: Install to temporary prefix
      run: |
        cmake --install build --prefix ${{ github.workspace }}/install
        echo ""
        echo "=== Installation Summary ==="
        echo "Install prefix: ${{ github.workspace }}/install"
        echo "Total installed files: $(find ${{ github.workspace }}/install -type f | wc -l)"
        echo ""

    - name: Verify installation structure
      run: |
        echo "=== Installed Libraries ==="
        find ${{ github.workspace }}/install -name "*.so*" -o -name "*.a" | sort
        echo ""
        echo "=== Installed Headers ==="
        find ${{ github.workspace }}/install -name "*.h" -o -name "*.hpp" | head -30
        echo ""
        echo "=== Installed Binaries ==="
        find ${{ github.workspace }}/install -type f -executable -name "*" | head -20
        echo ""
        echo "=== CMake Config Files ==="
        find ${{ github.workspace }}/install -name "*Config.cmake" -o -name "*-config.cmake" | head -20

    - name: Test external project linking
      run: |
        # Create a simple test project that links against installed libraries
        mkdir -p ${{ github.workspace }}/test-external
        cd ${{ github.workspace }}/test-external

        # Create a minimal CMakeLists.txt
        cat > CMakeLists.txt << 'EOF'
        cmake_minimum_required(VERSION 3.20)
        project(TestInstallation CXX)

        set(CMAKE_CXX_STANDARD 17)
        set(CMAKE_PREFIX_PATH "${{ github.workspace }}/install")

        # Try to find the installed package
        find_package(chimaera QUIET)

        if(chimaera_FOUND)
          message(STATUS "Found chimaera package")
          add_executable(test_app main.cpp)
          target_link_libraries(test_app chimaera::cxx)
        else()
          message(STATUS "chimaera package not found - creating minimal test")
          add_executable(test_app main.cpp)
        endif()
        EOF

        # Create a minimal test application
        cat > main.cpp << 'EOF'
        #include <iostream>
        int main() {
          std::cout << "Installation test successful" << std::endl;
          return 0;
        }
        EOF

        # Try to build
        cmake -B build -DCMAKE_PREFIX_PATH="${{ github.workspace }}/install"
        cmake --build build
        ./build/test_app
        echo ""
        echo "=== External project linking test PASSED ==="
      continue-on-error: true

    - name: Create package with CPack
      run: |
        cd build
        echo "=== Creating distribution packages with CPack ==="

        # Create TGZ package
        cpack -G TGZ

        # Create DEB package (Debian/Ubuntu)
        cpack -G DEB || echo "DEB package creation skipped or failed"

        echo ""
        echo "=== Generated packages ==="
        ls -lh *.tar.gz *.deb 2>/dev/null || echo "No packages found"

        # Show package contents
        if ls *.tar.gz 1> /dev/null 2>&1; then
          echo ""
          echo "=== Contents of TGZ package ==="
          tar -tzf *.tar.gz | head -50
        fi
      continue-on-error: true

    - name: Upload installation artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: install-${{ matrix.os }}
        path: ${{ github.workspace }}/install/
        retention-days: 7

    - name: Upload packages
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: packages-${{ matrix.os }}
        path: |
          build/*.tar.gz
          build/*.deb
        retention-days: 30

  build-summary:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Check build status
      run: |
        echo "Build and test workflow completed"
        echo "Status: ${{ needs.build-and-test.result }}"
