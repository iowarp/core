name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        os: ['ubuntu-24.04', 'ubuntu-24.04-arm']

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install system build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential cmake pkg-config \
          libelf-dev \
          libssl-dev \
          doxygen \
          perl

    - name: Install compression libraries
      run: |
        sudo apt-get install -y \
          libbz2-dev liblzo2-dev libzstd-dev liblz4-dev \
          zlib1g-dev liblzma-dev libbrotli-dev libsnappy-dev libblosc2-dev

    - name: Install MPI support
      run: |
        sudo apt-get install -y libmpich-dev

    - name: Build and install dependencies using install.sh
      run: |
        chmod +x install.sh
        sudo DEPS_ONLY=TRUE INSTALL_PREFIX=/usr/local ./install.sh
      env:
        DEBIAN_FRONTEND: noninteractive

    - name: Show system information
      run: |
        echo "=== System Information ==="
        uname -a
        echo ""
        echo "=== CPU Information ==="
        lscpu | grep -E "Architecture|CPU|Model name|Thread|Core"
        echo ""
        echo "=== Compiler Information ==="
        gcc --version
        g++ --version
        cmake --version
        echo ""
        echo "=== Installed Dependencies (apt) ==="
        dpkg -l | grep -E "libmpich" || true
        echo ""
        echo "=== Installed Dependencies (install.sh) ==="
        ls -la /usr/local/lib/libboost* /usr/local/lib/libzmq* /usr/local/lib/libhdf5* /usr/local/lib/libyaml* 2>/dev/null | head -20 || echo "Dependencies not yet visible"

    - name: Configure with CMake preset (debug)
      run: |
        git submodule update --init --recursive
        cmake --preset=debug \
          -DCMAKE_PREFIX_PATH="/usr/local/lib/cmake;/usr/local/cmake;/usr/local" \
          -DWRP_CORE_ENABLE_RUNTIME=ON \
          -DWRP_CORE_ENABLE_CTE=ON \
          -DWRP_CORE_ENABLE_CAE=ON \
          -DWRP_CORE_ENABLE_CEE=ON \
          -DWRP_CORE_ENABLE_TESTS=OFF
      env:
        CC: gcc
        CXX: g++
        PKG_CONFIG_PATH: /usr/local/lib/pkgconfig

    - name: Build all components
      run: |
        cmake --build build --parallel $(nproc)
      timeout-minutes: 60

    - name: Show build artifacts
      run: |
        echo "=== Build directory structure ==="
        find build -name "*.so" -o -name "*.a" -o -name "*_test" | head -50
        echo ""
        echo "=== Build size ==="
        du -sh build/

    - name: Run tests
      run: |
        cd build
        ctest -VV --output-on-failure --timeout 300
      timeout-minutes: 20
      continue-on-error: false

    - name: Upload test results on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.os }}
        path: |
          build/Testing/
          build/**/*_test.log
        retention-days: 7

    - name: Install to temporary prefix
      run: |
        cmake --install build --prefix ${{ github.workspace }}/install
        echo ""
        echo "=== Installation Summary ==="
        echo "Install prefix: ${{ github.workspace }}/install"
        echo "Total installed files: $(find ${{ github.workspace }}/install -type f | wc -l)"
        echo ""

    - name: Verify installation structure
      run: |
        echo "=== Installed Libraries ==="
        find ${{ github.workspace }}/install -name "*.so*" -o -name "*.a" | sort
        echo ""
        echo "=== Installed Headers ==="
        find ${{ github.workspace }}/install -name "*.h" -o -name "*.hpp" | head -30
        echo ""
        echo "=== Installed Binaries ==="
        find ${{ github.workspace }}/install -type f -executable -name "*" | head -20
        echo ""
        echo "=== CMake Config Files ==="
        find ${{ github.workspace }}/install -name "*Config.cmake" -o -name "*-config.cmake" | head -20

    - name: Test external project linking (CTE)
      run: |
        echo "=== Testing CTE external integration ==="
        cd context-transfer-engine/test/unit/external
        mkdir -p build && cd build
        cmake -DIowarpCore_DIR=${{ github.workspace }}/install/lib/cmake/iowarp-core \
              -DCMAKE_PREFIX_PATH=${{ github.workspace }}/install ..
        cmake --build .
        echo "CTE external test built successfully"
      continue-on-error: true

    - name: Test external project linking (Runtime)
      run: |
        echo "=== Testing Runtime external integration ==="
        cd context-runtime/test/unit/external
        mkdir -p build && cd build
        cmake -DIowarpCore_DIR=${{ github.workspace }}/install/lib/cmake/iowarp-core \
              -DCMAKE_PREFIX_PATH=${{ github.workspace }}/install ..
        cmake --build .
        echo "Runtime external test built successfully"
      continue-on-error: true

    - name: Test external project linking (Transport Primitives)
      run: |
        echo "=== Testing Transport Primitives external integration ==="
        cd context-transport-primitives/test/unit/external
        mkdir -p build && cd build
        cmake -DCMAKE_PREFIX_PATH=${{ github.workspace }}/install ..
        cmake --build .
        echo "Transport Primitives external test built successfully"
      continue-on-error: true

    - name: Create package with CPack
      run: |
        cd build
        echo "=== Creating distribution packages with CPack ==="

        # Create TGZ package
        cpack -G TGZ

        # Create DEB package (Debian/Ubuntu)
        cpack -G DEB || echo "DEB package creation skipped or failed"

        echo ""
        echo "=== Generated packages ==="
        ls -lh *.tar.gz *.deb 2>/dev/null || echo "No packages found"

        # Show package contents
        if ls *.tar.gz 1> /dev/null 2>&1; then
          echo ""
          echo "=== Contents of TGZ package ==="
          tar -tzf *.tar.gz | head -50
        fi
      continue-on-error: true

    - name: Upload installation artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: install-${{ matrix.os }}
        path: ${{ github.workspace }}/install/
        retention-days: 7

    - name: Upload packages
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: packages-${{ matrix.os }}
        path: |
          build/*.tar.gz
          build/*.deb
        retention-days: 30

  build-summary:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Check build status
      run: |
        echo "Build and test workflow completed"
        echo "Status: ${{ needs.build-and-test.result }}"
