name: Build Containers

# DEPRECATED: This workflow is kept for backward compatibility.
# Use build-dep-containers.yaml and build-core-containers.yaml instead.
#
# Container naming:
#   OLD NAME              -> NEW NAME
#   iowarp/iowarp-deps    -> iowarp/deps-cpu (or iowarp/deps-nvidia for GPU)
#   iowarp/core           -> iowarp/deploy-cpu

on:
  workflow_dispatch:
  workflow_call:

jobs:
  # Call the new core containers workflow
  build-core-containers:
    name: Build Core Containers (New)
    uses: ./.github/workflows/build-core-containers.yaml
    secrets: inherit

  # Build legacy aliases for backward compatibility
  build-legacy-aliases:
    name: Build Legacy Container Aliases
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: build-core-containers
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        id: buildx

      # Tag deploy-cpu as core for backward compatibility
      - name: Create core alias
        run: |
          docker buildx imagetools create \
            --tag iowarp/core:latest \
            iowarp/deploy-cpu:latest
