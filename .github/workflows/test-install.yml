name: Test Install Script

on:
  workflow_dispatch:

jobs:
  test-install-sh:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install basic build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          git \
          pkg-config \
          libtool \
          autoconf \
          automake

    - name: Install Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Show system information
      run: |
        echo "=== System Information ==="
        uname -a
        echo ""
        echo "=== Compiler Information ==="
        gcc --version
        g++ --version
        cmake --version
        python3 --version
        echo ""
        echo "=== Python Information ==="
        which python3
        python3 -m pip --version

    - name: Run install.sh script
      run: |
        echo "=== Running install.sh ==="
        chmod +x install.sh
        ./install.sh
      timeout-minutes: 60

    - name: Verify installation
      run: |
        echo "=== Verifying installation ==="
        export INSTALL_PREFIX="${HOME}/.local"

        echo ""
        echo "=== Installed Libraries ==="
        find "${INSTALL_PREFIX}/lib" -name "*.so*" -o -name "*.a" | head -20

        echo ""
        echo "=== Installed Headers ==="
        find "${INSTALL_PREFIX}/include" -type d -maxdepth 1 | head -20

        echo ""
        echo "=== CMake Config Files ==="
        find "${INSTALL_PREFIX}/lib/cmake" -name "*Config.cmake" | head -20

        echo ""
        echo "=== Installation Summary ==="
        echo "Total libraries: $(find "${INSTALL_PREFIX}/lib" -name "*.so*" | wc -l)"
        echo "Total headers: $(find "${INSTALL_PREFIX}/include" -name "*.h" -o -name "*.hpp" | wc -l)"
        echo "Total CMake configs: $(find "${INSTALL_PREFIX}/lib/cmake" -name "*Config.cmake" | wc -l)"

    - name: Test external project linking (CTE)
      run: |
        echo "=== Testing CTE external integration ==="
        export INSTALL_PREFIX="${HOME}/.local"
        cd context-transfer-engine/test/unit/external
        mkdir -p build && cd build
        cmake -DIowarpCore_DIR="${INSTALL_PREFIX}/lib/cmake/iowarp-core" \
              -DCMAKE_PREFIX_PATH="${INSTALL_PREFIX}" ..
        cmake --build .
        echo "CTE external test built successfully"
      continue-on-error: true

    - name: Test external project linking (Runtime)
      run: |
        echo "=== Testing Runtime external integration ==="
        export INSTALL_PREFIX="${HOME}/.local"
        cd context-runtime/test/unit/external
        mkdir -p build && cd build
        cmake -DIowarpCore_DIR="${INSTALL_PREFIX}/lib/cmake/iowarp-core" \
              -DCMAKE_PREFIX_PATH="${INSTALL_PREFIX}" ..
        cmake --build .
        echo "Runtime external test built successfully"
      continue-on-error: true

    - name: Test external project linking (Transport Primitives)
      run: |
        echo "=== Testing Transport Primitives external integration ==="
        export INSTALL_PREFIX="${HOME}/.local"
        cd context-transport-primitives/test/unit/external
        mkdir -p build && cd build
        cmake -DCMAKE_PREFIX_PATH="${INSTALL_PREFIX}" ..
        cmake --build .
        echo "Transport Primitives external test built successfully"
      continue-on-error: true

    - name: Show installation size
      run: |
        export INSTALL_PREFIX="${HOME}/.local"
        echo "=== Installation Size ==="
        du -sh "${INSTALL_PREFIX}/lib" 2>/dev/null || echo "lib directory not found"
        du -sh "${INSTALL_PREFIX}/include" 2>/dev/null || echo "include directory not found"
        du -sh "${INSTALL_PREFIX}/bin" 2>/dev/null || echo "bin directory not found"
