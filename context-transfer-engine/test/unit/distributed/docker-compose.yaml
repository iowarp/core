services:
  # Node 1 - Primary node that builds and runs tests
  cte-node1:
    image: iowarp/core-build:latest
    pull_policy: never
    container_name: cte-distributed-node1
    hostname: iowarp-node1
    networks:
      cte-cluster:
        ipv4_address: 172.26.0.10
    volumes:
      # Use HOST_WORKSPACE for Docker-in-Docker environments (devcontainers)
      # HOST_WORKSPACE should be the actual host path, not the container mount point
      - ${HOST_WORKSPACE:-${IOWARP_CORE_ROOT:-.}}/context-transfer-engine/test/unit/distributed:/test_config:ro
      - ${HOST_WORKSPACE:-${IOWARP_CORE_ROOT:-.}}/build:/workspace/build:rw
      - hdd1-storage:/mnt/hdd1
      - hdd2-storage:/mnt/hdd2
      - hdd3-storage:/mnt/hdd3
      - hdd4-storage:/mnt/hdd4
    environment:
      - NODE_ID=1
      - NODE_IP=172.26.0.10
      - CONTAINER_HOSTFILE=/test_config/hostfile
      - TEST_FILTER=${TEST_FILTER:-}
      - SECTION_FILTER=${SECTION_FILTER:-}
      - WRP_RUNTIME_CONF=/test_config/wrp_config.yaml
      - CTE_NUM_NODES=4
      - CHIMAERA_WITH_RUNTIME=0
    shm_size: '16gb'
    mem_limit: 16g
    entrypoint: [ "/bin/bash", "-c" ]
    command: >
      "
        set -x &&
        echo '========================================' &&
        echo 'Node 1: Starting initialization' &&
        echo '========================================' &&
        echo 'Node 1: Setting up permissions...' &&
        sudo chown -R iowarp:iowarp /mnt &&
        echo 'Node 1: Creating storage directories...' &&
        mkdir -p /mnt/hdd1 /mnt/hdd2 /mnt/hdd3 /mnt/hdd4 &&
        export PATH=/usr/local/bin:$$PATH &&
        export WRP_RUNTIME_CONF=/test_config/wrp_config.yaml &&
        export CONTAINER_HOSTFILE=/test_config/hostfile &&
        echo '========================================' &&
        echo 'Node 1: Starting Chimaera runtime in background' &&
        echo '========================================' &&
        chimaera_start_runtime &
        RUNTIME_PID=$$! &&
        echo \"Node 1: Runtime started (PID $$RUNTIME_PID)\" &&
        sleep 2 &&
        echo '========================================' &&
        echo 'Node 1: Running distributed unit tests' &&
        echo '========================================' &&
        echo 'Flushing output before test execution...' &&
        sync &&
        if [ -z \"$$TEST_FILTER\" ]; then
          echo 'Running all tests (no filter)' &&
          test_core_functionality 2>&1
          TEST_EXIT_CODE=$$?
        else
          echo \"Test filter: $$TEST_FILTER\" &&
          test_core_functionality \"$$TEST_FILTER\" 2>&1
          TEST_EXIT_CODE=$$?
        fi &&
        echo '========================================'
        echo 'Node 1: Tests complete'
        echo '========================================'
        exit $$TEST_EXIT_CODE
      "

  # Node 2 - Secondary node
  cte-node2:
    image: iowarp/core-build:latest
    pull_policy: never
    container_name: cte-distributed-node2
    hostname: iowarp-node2
    networks:
      cte-cluster:
        ipv4_address: 172.26.0.11
    volumes:
      - ${HOST_WORKSPACE:-${IOWARP_CORE_ROOT:-.}}/context-transfer-engine/test/unit/distributed:/test_config:ro
      - ${HOST_WORKSPACE:-${IOWARP_CORE_ROOT:-.}}/build:/workspace/build:rw
      - hdd2-storage:/mnt/hdd2
    environment:
      - NODE_ID=2
      - NODE_IP=172.26.0.11
      - CONTAINER_HOSTFILE=/test_config/hostfile
      - WRP_RUNTIME_CONF=/test_config/wrp_config.yaml
      - CTE_NUM_NODES=4
    shm_size: '16gb'
    mem_limit: 16g
    entrypoint: [ "/bin/bash", "-c" ]
    command: >
      "
        set -x &&
        echo '========================================' &&
        echo 'Node 2: Starting initialization' &&
        echo '========================================' &&
        sudo chown -R iowarp:iowarp /mnt &&
        mkdir -p /mnt/hdd2 &&
        export PATH=/usr/local/bin:$$PATH &&
        export WRP_RUNTIME_CONF=/test_config/wrp_config.yaml &&
        export CONTAINER_HOSTFILE=/test_config/hostfile &&
        echo '========================================' &&
        echo 'Node 2: Starting Chimaera runtime in foreground' &&
        echo '========================================' &&
        chimaera_start_runtime
      "

  # Node 3 - Secondary node
  cte-node3:
    image: iowarp/core-build:latest
    pull_policy: never
    container_name: cte-distributed-node3
    hostname: iowarp-node3
    networks:
      cte-cluster:
        ipv4_address: 172.26.0.12
    volumes:
      - ${HOST_WORKSPACE:-${IOWARP_CORE_ROOT:-.}}/context-transfer-engine/test/unit/distributed:/test_config:ro
      - ${HOST_WORKSPACE:-${IOWARP_CORE_ROOT:-.}}/build:/workspace/build:rw
      - hdd3-storage:/mnt/hdd3
    environment:
      - NODE_ID=3
      - NODE_IP=172.26.0.12
      - CONTAINER_HOSTFILE=/test_config/hostfile
      - WRP_RUNTIME_CONF=/test_config/wrp_config.yaml
      - CTE_NUM_NODES=4
    shm_size: '16gb'
    mem_limit: 16g
    entrypoint: [ "/bin/bash", "-c" ]
    command: >
      "
        set -x &&
        echo '========================================' &&
        echo 'Node 3: Starting initialization' &&
        echo '========================================' &&
        sudo chown -R iowarp:iowarp /mnt &&
        mkdir -p /mnt/hdd3 &&
        export PATH=/usr/local/bin:$$PATH &&
        export WRP_RUNTIME_CONF=/test_config/wrp_config.yaml &&
        export CONTAINER_HOSTFILE=/test_config/hostfile &&
        echo '========================================' &&
        echo 'Node 3: Starting Chimaera runtime in foreground' &&
        echo '========================================' &&
        chimaera_start_runtime
      "

  # Node 4 - Secondary node
  cte-node4:
    image: iowarp/core-build:latest
    pull_policy: never
    container_name: cte-distributed-node4
    hostname: iowarp-node4
    networks:
      cte-cluster:
        ipv4_address: 172.26.0.13
    volumes:
      - ${HOST_WORKSPACE:-${IOWARP_CORE_ROOT:-.}}/context-transfer-engine/test/unit/distributed:/test_config:ro
      - ${HOST_WORKSPACE:-${IOWARP_CORE_ROOT:-.}}/build:/workspace/build:rw
      - hdd4-storage:/mnt/hdd4
    environment:
      - NODE_ID=4
      - NODE_IP=172.26.0.13
      - CONTAINER_HOSTFILE=/test_config/hostfile
      - WRP_RUNTIME_CONF=/test_config/wrp_config.yaml
      - CTE_NUM_NODES=4
    shm_size: '16gb'
    mem_limit: 16g
    entrypoint: [ "/bin/bash", "-c" ]
    command: >
      "
        set -x &&
        echo '========================================' &&
        echo 'Node 4: Starting initialization' &&
        echo '========================================' &&
        sudo chown -R iowarp:iowarp /mnt &&
        mkdir -p /mnt/hdd4 &&
        export PATH=/usr/local/bin:$$PATH &&
        export WRP_RUNTIME_CONF=/test_config/wrp_config.yaml &&
        export CONTAINER_HOSTFILE=/test_config/hostfile &&
        echo '========================================' &&
        echo 'Node 4: Starting Chimaera runtime in foreground' &&
        echo '========================================' &&
        chimaera_start_runtime
      "

volumes:
  hdd1-storage:
    driver: local
  hdd2-storage:
    driver: local
  hdd3-storage:
    driver: local
  hdd4-storage:
    driver: local

networks:
  cte-cluster:
    driver: bridge
    ipam:
      config:
        - subnet: 172.26.0.0/16
