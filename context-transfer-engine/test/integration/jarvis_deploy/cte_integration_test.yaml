# CTE Integration Test Pipeline
# Tests the IOWarp runtime + CTE deployment via Jarvis on a 2-node Docker cluster.
#
# Node 1 (primary): Runs this pipeline via `jarvis ppl run yaml`
# Node 2 (secondary): Serves SSH connections; runtime is started here via pssh
#
# The env section is intentionally omitted: Jarvis auto-captures PATH, LD_LIBRARY_PATH,
# and other variables from the container's shell environment at runtime.

name: cte_integration_test

pkgs:
  # Stage 1: Launch IOWarp runtime on all nodes in the hostfile (via parallel SSH)
  - pkg_type: jarvis_iowarp.wrp_runtime
    pkg_name: runtime
    num_threads: 4
    client_data_segment_size: "2G"
    port: 9413
    ipc_mode: "tcp"
    log_level: "info"
    sleep: 8    # Seconds to wait after starting runtime for cluster formation

  # Stage 2: Deploy CTE pools on all nodes (via parallel SSH + chimaera compose)
  - pkg_type: jarvis_iowarp.wrp_cte
    pkg_name: cte_core
    devices:
      - ["ram::cte_ram_tier1", "4GB", 1.0]
    dpe_type: "max_bw"
    neighborhood: 2
    default_target_timeout_ms: 30000
    poll_period_ms: 5000

  # Stage 3: Run CTE benchmark (single process on node1, client-only mode)
  - pkg_type: jarvis_iowarp.wrp_cte_bench
    pkg_name: cte_bench
    test_case: "PutGet"
    num_threads: 2
    depth: 2
    io_size: "1m"
    io_count: 10
    nprocs: 1
    ppn: 1
    init_runtime: false
