# Jarvis Deployment Integration Test for Context Transfer Engine (CTE)
# Uses Jarvis pipeline runner to deploy IOWarp across a 2-node Docker cluster.
#
# Node 1 (primary):
#   - Sets up SSH key pair and shares public key via the workspace volume
#   - Installs workspace jarvis-cd (ensures version compatibility)
#   - Initializes Jarvis with a shared_dir on the workspace volume (accessible to all nodes)
#   - Adds jarvis_iowarp package repository
#   - Sets the hostfile and runs the pipeline via `jarvis ppl run yaml`
#
# Node 2 (secondary):
#   - Waits for node1's SSH public key to appear in the shared workspace path
#   - Adds node1's key to authorized_keys and starts sshd in foreground
#   - Does nothing else: the IOWarp runtime is started here via pssh from node1
#
# Usage:
#   ./run_tests.sh
#
#   # With custom workspace path (for devcontainers)
#   HOST_WORKSPACE=/host/path/to/workspace ./run_tests.sh

services:
  # Node 1 - Primary node that initialises Jarvis and runs the pipeline
  cte-jarvis-node1:
    image: iowarp/deps-cpu:latest
    security_opt:
      - seccomp:unconfined
    container_name: cte-jarvis-node1
    hostname: iowarp-jarvis-node1
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    networks:
      jarvis-cluster:
        ipv4_address: 172.27.0.10
    volumes:
      - ${HOST_WORKSPACE:-${IOWARP_CORE_ROOT:-/workspace}}:/workspace:rw
    environment:
      - NODE_ID=1
      - NODE_IP=172.27.0.10
      - PATH=/workspace/build/bin:/home/iowarp/venv/bin:/home/iowarp/.cargo/bin:/usr/local/bin:/usr/bin:/bin
      - LD_LIBRARY_PATH=/workspace/build/bin:/usr/local/lib
      - OMPI_ALLOW_RUN_AS_ROOT=1
      - OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
    mem_limit: 16g
    working_dir: /workspace
    entrypoint:
      - /bin/bash
      - /workspace/context-transfer-engine/test/integration/jarvis_deploy/node1_entrypoint.sh

  # Node 2 - Secondary node: SSH server only; IOWarp runtime started here via pssh from node1
  cte-jarvis-node2:
    image: iowarp/deps-cpu:latest
    security_opt:
      - seccomp:unconfined
    container_name: cte-jarvis-node2
    hostname: iowarp-jarvis-node2
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    networks:
      jarvis-cluster:
        ipv4_address: 172.27.0.11
    volumes:
      - ${HOST_WORKSPACE:-${IOWARP_CORE_ROOT:-/workspace}}:/workspace:rw
    environment:
      - NODE_ID=2
      - NODE_IP=172.27.0.11
      - PATH=/workspace/build/bin:/home/iowarp/venv/bin:/usr/local/bin:/usr/bin:/bin
      - LD_LIBRARY_PATH=/workspace/build/bin:/usr/local/lib
      - OMPI_ALLOW_RUN_AS_ROOT=1
      - OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
    mem_limit: 16g
    working_dir: /workspace
    entrypoint:
      - /bin/bash
      - /workspace/context-transfer-engine/test/integration/jarvis_deploy/node2_entrypoint.sh

networks:
  jarvis-cluster:
    driver: bridge
    ipam:
      config:
        - subnet: 172.27.0.0/16
