# Distributed Integration Tests for Context Transfer Engine (CTE)
# Uses deps-cpu container with mounted build directory for coverage support
#
# Usage:
#   # Standard run
#   ./run_tests.sh
#
#   # With custom workspace path (for devcontainers)
#   HOST_WORKSPACE=/host/path/to/workspace ./run_tests.sh
#
#   # Run specific test
#   ./run_tests.sh -t "PutBlob"
#
# Coverage: gcda files are written directly to the mounted build directory,
# allowing coverage data to be collected after test execution.

services:
  # Node 1 - Primary node that runs tests
  cte-node1:
    image: iowarp/deps-cpu:latest
    security_opt:
      - seccomp:unconfined
    container_name: cte-distributed-node1
    hostname: iowarp-node1
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    networks:
      cte-cluster:
        ipv4_address: 172.26.0.10
    volumes:
      # Mount the entire workspace for coverage support
      - ${HOST_WORKSPACE:-${IOWARP_CORE_ROOT:-/workspace}}:/workspace:rw
    tmpfs:
      - /mnt:mode=1777
    environment:
      - NODE_ID=1
      - NODE_IP=172.26.0.10
      - CHI_SERVER_CONF=/workspace/context-transfer-engine/test/integration/distributed/wrp_config.yaml
      - CONTAINER_HOSTFILE=/workspace/context-transfer-engine/test/integration/distributed/hostfile
      - TEST_FILTER=${TEST_FILTER:-}
      - SECTION_FILTER=${SECTION_FILTER:-}
      - CTE_NUM_NODES=4
      - CHI_WITH_RUNTIME=0
      - PATH=/workspace/build/bin:/usr/local/bin:/usr/bin:/bin
      - LD_LIBRARY_PATH=/workspace/build/bin:$LD_LIBRARY_PATH
    mem_limit: 16g
    working_dir: /workspace
    entrypoint: [ "/bin/bash", "-c" ]
    command: >
      "
        set -x &&
        echo '========================================' &&
        echo 'Node 1: Starting Chimaera runtime in background' &&
        echo '========================================' &&
        /workspace/build/bin/chimaera runtime start &
        RUNTIME_PID=$$! &&
        echo \"Node 1: Runtime started (PID $$RUNTIME_PID)\" &&
        sleep 3 &&
        echo '========================================' &&
        echo 'Node 1: Running distributed unit tests' &&
        echo '========================================' &&
        sync &&
        if [ -z \"$$TEST_FILTER\" ]; then
          echo 'Running all tests (no filter)' &&
          /workspace/build/bin/test_core_functionality 2>&1
          TEST_EXIT_CODE=$$?
        else
          echo \"Test filter: $$TEST_FILTER\" &&
          /workspace/build/bin/test_core_functionality \"$$TEST_FILTER\" 2>&1
          TEST_EXIT_CODE=$$?
        fi &&
        echo '========================================' &&
        echo 'Node 1: Tests complete' &&
        echo '========================================' &&
        exit $$TEST_EXIT_CODE
      "

  # Node 2 - Secondary node
  cte-node2:
    image: iowarp/deps-cpu:latest
    security_opt:
      - seccomp:unconfined
    container_name: cte-distributed-node2
    hostname: iowarp-node2
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    networks:
      cte-cluster:
        ipv4_address: 172.26.0.11
    volumes:
      - ${HOST_WORKSPACE:-${IOWARP_CORE_ROOT:-/workspace}}:/workspace:rw
    tmpfs:
      - /mnt:mode=1777
    environment:
      - NODE_ID=2
      - NODE_IP=172.26.0.11
      - CHI_SERVER_CONF=/workspace/context-transfer-engine/test/integration/distributed/wrp_config.yaml
      - CONTAINER_HOSTFILE=/workspace/context-transfer-engine/test/integration/distributed/hostfile
      - CTE_NUM_NODES=4
      - PATH=/workspace/build/bin:/usr/local/bin:/usr/bin:/bin
      - LD_LIBRARY_PATH=/workspace/build/bin:$LD_LIBRARY_PATH
    mem_limit: 16g
    working_dir: /workspace
    entrypoint: [ "/bin/bash", "-c" ]
    command: >
      "
        echo 'Node 2: Starting Chimaera runtime in foreground' &&
        /workspace/build/bin/chimaera runtime start
      "

  # Node 3 - Secondary node
  cte-node3:
    image: iowarp/deps-cpu:latest
    security_opt:
      - seccomp:unconfined
    container_name: cte-distributed-node3
    hostname: iowarp-node3
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    networks:
      cte-cluster:
        ipv4_address: 172.26.0.12
    volumes:
      - ${HOST_WORKSPACE:-${IOWARP_CORE_ROOT:-/workspace}}:/workspace:rw
    tmpfs:
      - /mnt:mode=1777
    environment:
      - NODE_ID=3
      - NODE_IP=172.26.0.12
      - CHI_SERVER_CONF=/workspace/context-transfer-engine/test/integration/distributed/wrp_config.yaml
      - CONTAINER_HOSTFILE=/workspace/context-transfer-engine/test/integration/distributed/hostfile
      - CTE_NUM_NODES=4
      - PATH=/workspace/build/bin:/usr/local/bin:/usr/bin:/bin
      - LD_LIBRARY_PATH=/workspace/build/bin:$LD_LIBRARY_PATH
    mem_limit: 16g
    working_dir: /workspace
    entrypoint: [ "/bin/bash", "-c" ]
    command: >
      "
        echo 'Node 3: Starting Chimaera runtime in foreground' &&
        /workspace/build/bin/chimaera runtime start
      "

  # Node 4 - Secondary node
  cte-node4:
    image: iowarp/deps-cpu:latest
    security_opt:
      - seccomp:unconfined
    container_name: cte-distributed-node4
    hostname: iowarp-node4
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    networks:
      cte-cluster:
        ipv4_address: 172.26.0.13
    volumes:
      - ${HOST_WORKSPACE:-${IOWARP_CORE_ROOT:-/workspace}}:/workspace:rw
    tmpfs:
      - /mnt:mode=1777
    environment:
      - NODE_ID=4
      - NODE_IP=172.26.0.13
      - CHI_SERVER_CONF=/workspace/context-transfer-engine/test/integration/distributed/wrp_config.yaml
      - CONTAINER_HOSTFILE=/workspace/context-transfer-engine/test/integration/distributed/hostfile
      - CTE_NUM_NODES=4
      - PATH=/workspace/build/bin:/usr/local/bin:/usr/bin:/bin
      - LD_LIBRARY_PATH=/workspace/build/bin:$LD_LIBRARY_PATH
    mem_limit: 16g
    working_dir: /workspace
    entrypoint: [ "/bin/bash", "-c" ]
    command: >
      "
        echo 'Node 4: Starting Chimaera runtime in foreground' &&
        /workspace/build/bin/chimaera runtime start
      "

networks:
  cte-cluster:
    driver: bridge
    ipam:
      config:
        - subnet: 172.26.0.0/16
