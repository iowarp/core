# Reconnect Integration Tests for Chimaera Runtime
# Tests client failover to a new host when the connected server dies:
# 1. Start 4-node cluster
# 2. Client on node 1 connects to local runtime
# 3. Client shuts down node 1's runtime via AsyncStopRuntime
# 4. Client sends another task â€” WaitForServerAndReconnect triggers
# 5. Phase 1 (original server) times out quickly
# 6. Phase 2 (CHI_CLIENT_TRY_NEW_SERVERS) tries random hosts from hostfile
# 7. Client reconnects to a surviving node and the task completes
#
# Usage:
#   docker compose up -d
#   docker exec iowarp-reconnect-node1 bash -c "chimaera_reconnect_tests '[reconnect]'"

services:
  # Node 1 - Test coordinator (runtime will be shut down by the test)
  iowarp-node1:
    image: iowarp/deps-cpu:latest
    security_opt:
      - seccomp:unconfined
    container_name: iowarp-reconnect-node1
    hostname: iowarp-node1
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    networks:
      iowarp-reconnect-cluster:
        ipv4_address: 172.29.0.10
    volumes:
      - ${HOST_WORKSPACE:-${IOWARP_CORE_ROOT:-/workspace}}:/workspace:rw
    environment:
      - NODE_ID=1
      - NODE_IP=172.29.0.10
      - CHI_SERVER_CONF=/workspace/context-runtime/test/integration/reconnect/wrp_conf.yaml
      - CONTAINER_HOSTFILE=/workspace/context-runtime/test/integration/reconnect/hostfile
      - CHI_WITH_RUNTIME=0
      - CHI_NUM_CONTAINERS=4
      - CHI_CLIENT_RETRY_TIMEOUT=5
      - CHI_CLIENT_TRY_NEW_SERVERS=16
      - PATH=/workspace/build/bin:/usr/local/bin:/usr/bin:/bin
      - LD_LIBRARY_PATH=/workspace/build/bin:$LD_LIBRARY_PATH
    mem_limit: 16g
    working_dir: /workspace
    entrypoint: [ "/bin/bash", "-c" ]
    command: >
      "
        echo 'Node 1: Starting runtime in background...' &&
        /workspace/build/bin/chimaera runtime start &
        RUNTIME_PID=\$! &&
        echo 'Node 1: Runtime started (PID \$RUNTIME_PID). Container stays alive for test runner.' &&
        sleep infinity
      "

  # Node 2
  iowarp-node2:
    image: iowarp/deps-cpu:latest
    security_opt:
      - seccomp:unconfined
    container_name: iowarp-reconnect-node2
    hostname: iowarp-node2
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    networks:
      iowarp-reconnect-cluster:
        ipv4_address: 172.29.0.11
    volumes:
      - ${HOST_WORKSPACE:-${IOWARP_CORE_ROOT:-/workspace}}:/workspace:rw
    environment:
      - NODE_ID=2
      - NODE_IP=172.29.0.11
      - CHI_SERVER_CONF=/workspace/context-runtime/test/integration/reconnect/wrp_conf.yaml
      - CONTAINER_HOSTFILE=/workspace/context-runtime/test/integration/reconnect/hostfile
      - CHI_WITH_RUNTIME=0
      - CHI_NUM_CONTAINERS=4
      - PATH=/workspace/build/bin:/usr/local/bin:/usr/bin:/bin
      - LD_LIBRARY_PATH=/workspace/build/bin:$LD_LIBRARY_PATH
    mem_limit: 16g
    working_dir: /workspace
    entrypoint: [ "/bin/bash", "-c" ]
    command: >
      "
        echo 'Node 2: Starting runtime...' &&
        /workspace/build/bin/chimaera runtime start
      "

  # Node 3
  iowarp-node3:
    image: iowarp/deps-cpu:latest
    security_opt:
      - seccomp:unconfined
    container_name: iowarp-reconnect-node3
    hostname: iowarp-node3
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    networks:
      iowarp-reconnect-cluster:
        ipv4_address: 172.29.0.12
    volumes:
      - ${HOST_WORKSPACE:-${IOWARP_CORE_ROOT:-/workspace}}:/workspace:rw
    environment:
      - NODE_ID=3
      - NODE_IP=172.29.0.12
      - CHI_SERVER_CONF=/workspace/context-runtime/test/integration/reconnect/wrp_conf.yaml
      - CONTAINER_HOSTFILE=/workspace/context-runtime/test/integration/reconnect/hostfile
      - CHI_WITH_RUNTIME=0
      - CHI_NUM_CONTAINERS=4
      - PATH=/workspace/build/bin:/usr/local/bin:/usr/bin:/bin
      - LD_LIBRARY_PATH=/workspace/build/bin:$LD_LIBRARY_PATH
    mem_limit: 16g
    working_dir: /workspace
    entrypoint: [ "/bin/bash", "-c" ]
    command: >
      "
        echo 'Node 3: Starting runtime...' &&
        /workspace/build/bin/chimaera runtime start
      "

  # Node 4
  iowarp-node4:
    image: iowarp/deps-cpu:latest
    security_opt:
      - seccomp:unconfined
    container_name: iowarp-reconnect-node4
    hostname: iowarp-node4
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    networks:
      iowarp-reconnect-cluster:
        ipv4_address: 172.29.0.13
    volumes:
      - ${HOST_WORKSPACE:-${IOWARP_CORE_ROOT:-/workspace}}:/workspace:rw
    environment:
      - NODE_ID=4
      - NODE_IP=172.29.0.13
      - CHI_SERVER_CONF=/workspace/context-runtime/test/integration/reconnect/wrp_conf.yaml
      - CONTAINER_HOSTFILE=/workspace/context-runtime/test/integration/reconnect/hostfile
      - CHI_WITH_RUNTIME=0
      - CHI_NUM_CONTAINERS=4
      - PATH=/workspace/build/bin:/usr/local/bin:/usr/bin:/bin
      - LD_LIBRARY_PATH=/workspace/build/bin:$LD_LIBRARY_PATH
    mem_limit: 16g
    working_dir: /workspace
    entrypoint: [ "/bin/bash", "-c" ]
    command: >
      "
        echo 'Node 4: Starting runtime...' &&
        /workspace/build/bin/chimaera runtime start
      "

networks:
  iowarp-reconnect-cluster:
    driver: bridge
    ipam:
      config:
        - subnet: 172.29.0.0/16
