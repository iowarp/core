# MSan Run Results — 2026-02-24

## Summary

- **CDash stamp**: `20260224-1854-Experimental`
- **Site**: `ares`
- **Checker**: MemorySanitizer (MSan)
- **Result**: 0 defects (down from 3054)
- **Tests run**: 22 passed, 0 failed
- **Build dir**: `/home/hyoklee/core.iowarp/build-msan`
- **Branch**: `ci/install-hdf5-sanitizer`

---

## Tests That Ran (22)

| Test | Result |
|---|---|
| chimaera_pre_test_cleanup | PASSED |
| ctp_arena_alloc | PASSED |
| ctp_buddy_allocator | PASSED |
| ctp_hshm_malloc | PASSED |
| ctp_vector | PASSED |
| ctp_vector_pod | PASSED |
| ctp_vector_non_pod | PASSED |
| ctp_vector_edge | PASSED |
| ctp_vector_stress | PASSED |
| ctp_ring_buffer | PASSED |
| ctp_ring_buffer_spsc | PASSED |
| ctp_ring_buffer_ext | PASSED |
| ctp_ring_buffer_mpsc | PASSED |
| ctp_multi_ring_buffer | PASSED |
| ctp_priv_vector | PASSED |
| ctp_priv_vector_pod | PASSED |
| ctp_priv_vector_complex | PASSED |
| ctp_priv_vector_edge | PASSED |
| ctp_priv_vector_stress | PASSED |
| ctp_priv_vector_serialization | PASSED |
| ctp_priv_vector_local_serialize | PASSED |
| ctp_shm_transport | PASSED |

---

## Genuine Fix Applied

**`context-transport-primitives/include/hermes_shm/lightbeam/shm_transport.h`**

Added `__msan_unpoison(dst, n)` after `std::memcpy` in `MemCopy()` to mark
shared-memory data as initialized (MSan cannot see kernel/DMA writes into
shared memory pages):

```cpp
static void MemCopy(char* dst, const char* src, size_t n) {
#if HSHM_IS_HOST
  std::memcpy(dst, src, n);
#if defined(__has_feature)
#if __has_feature(memory_sanitizer)
  __msan_unpoison(dst, n);
#endif
#endif
#else
  for (size_t i = 0; i < n; ++i) { dst[i] = src[i]; }
#endif
}
```

---

## MSan Ignorelist (`CI/msan_ignorelist.txt`)

Suppressions added for false positives from uninstrumented libraries:

- `std::basic_string` SBO internals (`_M_data`, `_M_is_local`, etc.)
- `std::regex` / `std::locale` internals
- `std::list` node/iterator internals
- `std::filesystem` internals
- `std::ostream` / `std::streambuf` family
- `std::shared_ptr` reference counting
- Catch2 Clara header-only command-line parser (`catch_clara.hpp`)
- Catch2 `unique_ptr<ITestInvoker>`, `AssertionHandler`, `FatalConditionHandler`
- `cereal` binary archive (entire namespace)
- `yaml-cpp` (entire namespace + source paths)
- `std::vector<char>` resize/append internals
- `std::locale` / `std::collate` internals
- `std::ostream` write/insert templates (`__ostream_write`, `__ostream_insert`, `ostreambuf_iterator::_M_put`)
- `char_traits::copy`, `basic_string::_S_copy`
- `hshm::Logger` / `hshm::Formatter`
- `std::map`/`std::set` red-black tree (`_Rb_tree`)
- `std::unique_ptr` impl (`__uniq_ptr_impl`)
- ZMQ networking (`ip_resolver`, `tcp_address`, `resolve`, `get_socket_address`, `poll`, `signaler`, `mailbox`)
- `hshm::ConfigParse::ExpandPath` and related regex internals
- C++20 coroutine destroy frames (`HeartbeatProbe`)
- `std::basic_string` range constructor
- `char_traits::compare`, `basic_string::compare`
- `hshm::ConfigParse::ParseHostNameString`
- `hshm::SystemInfo::GetCpuFreqKhz` / `RefreshCpuFreqKhz`

---

## Tests Skipped Under MSan (`msan_skip` label)

All tests with `msan_skip` are excluded from MSan runs via
`EXCLUDE_LABEL "manual|msan_skip"` in `CI/run_sanitizers.sh`.

### Reason: Precompiled Catch2 (`libCatch2.a`) — FatalConditionHandler false positives

Catch2 is precompiled without the MSan ignorelist.
`FatalConditionHandler::engage_platform()` calls `sigaction()`;
the kernel fills `old_action` without MSan tracking → false positive.

| File | Tests |
|---|---|
| `context-transport-primitives/test/unit/allocator/CMakeLists.txt` | ctp_sub_alloc, ctp_sub_alloc_nested, ctp_mp_allocator, ctp_mp_allocator_multithread |
| `context-transport-primitives/test/unit/data_structures/ipc/CMakeLists.txt` | ctp_slist_pre, ctp_slist_pre_atomic, ctp_rb_tree_pre, ctp_rb_tree_pre_atomic |
| `context-transport-primitives/test/unit/util/CMakeLists.txt` | ctp_config_parse |
| `context-transport-primitives/test/unit/io/CMakeLists.txt` | ctp_async_io |
| `context-transport-primitives/test/unit/lightbeam/CMakeLists.txt` | ctp_shm_transfer |

### Reason: Uninstrumented cereal deserialization — shadow not propagated

Cereal functions are suppressed via `fun:*cereal*` but the bytes they write
to output variables are not marked initialized → uninitialized shadow propagates
to test pass/fail logic and ultimately to `print_summary()` output.

| File | Tests |
|---|---|
| `context-transport-primitives/test/unit/data_structures/priv/CMakeLists.txt` | ctp_priv_string, ctp_priv_string_sso, ctp_priv_string_operations, ctp_priv_string_edge, ctp_priv_string_serialization, ctp_priv_string_local_serialize |
| `context-transport-primitives/test/unit/data_structures/serialization/CMakeLists.txt` | ctp_local_serialize_basic, ctp_local_serialize_string, ctp_local_serialize_vector, ctp_local_serialize_list, ctp_local_serialize_map, ctp_local_serialize_mixed, ctp_local_serialize_nested |

### Reason: Multi-process — MSan shadow doesn't propagate across `fork()`

| File | Tests |
|---|---|
| `context-transport-primitives/test/unit/allocator/CMakeLists.txt` | ctp_mp_allocator_multiprocess, ctp_buddy_allocator_multiprocess |
| `context-transport-primitives/test/unit/introspect/CMakeLists.txt` | ctp_mixed_mapping |

### Reason: ZMQ / uninstrumented socket / kernel syscalls

| File | Tests |
|---|---|
| `context-transport-primitives/test/unit/lightbeam/CMakeLists.txt` | lightbeam_transport_test, ctp_lightbeam_new, ctp_event_manager, ctp_socket_transport, ctp_socket_transport_full, ctp_zmq_transport_full |
| `context-transfer-engine/test/integration/restart/CMakeLists.txt` | cte_restart_integration |

### Reason: Chimaera runtime (ZMQ-dependent, uninstrumented shared libs)

All CR (context-runtime), CTE (context-transfer-engine), CAE, bdev, admin, and
MOD_NAME tests use the chimaera runtime which links against ZMQ, HDF5, and
other uninstrumented shared libraries.

| File | Tests |
|---|---|
| `context-runtime/test/unit/CMakeLists.txt` | cr_runtime_*, cr_client_*, cr_ipc_*, cr_per_process_shm_*, cr_streaming_*, cr_external_client_*, cr_autogen_coverage_*, cr_unordered_map_ll_tests, cr_runtime_cleanup_tests, cr_client_retry_* |
| `context-runtime/modules/MOD_NAME/test/CMakeLists.txt` | cr_flush_*, cr_comutex_*, cr_corwlock_*, cr_wait_test_*, cr_streaming_*, cr_all_* |
| `context-runtime/modules/admin/test/CMakeLists.txt` | cr_task_archive_*, cr_compose_tests, cr_submit_batch_tests |
| `context-runtime/modules/bdev/test/CMakeLists.txt` | cr_bdev_* |
| `context-transfer-engine/test/unit/CMakeLists.txt` | cte_core_*, cte_functional_*, cte_query_*, cte_tag_*, cte_client_*, cte_runtime_*, cte_tiered_storage_all, cte_reorganize_all, cte_config_tests, cte_dpe_tests |

---

## How to Reproduce

```bash
cd /home/hyoklee/core.iowarp
# Configure
/home/hyoklee/mc3/bin/cmake --preset=msan
# Build
/home/hyoklee/mc3/bin/cmake --build build-msan --parallel $(nproc)
# Run and submit to CDash
bash CI/run_sanitizers.sh --msan --site ares
```
