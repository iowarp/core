# Gray-Scott Jarvis Pipeline

This directory contains Jarvis pipeline configurations for running the Gray-Scott reaction-diffusion simulation workflow.

## Files

- **gray-scott.yaml** - Main Jarvis pipeline configuration (edit this to change parameters)
- **gray-scott-settings.json** - Generated gray-scott simulation settings (auto-generated by `configure`)
- **gray-scott-adios2.xml** - Generated ADIOS2 I/O configuration (auto-generated by `configure`)

## Quick Start

### Option 1: Single Command (Recommended)

```bash
cd /workspace/external/iowarp-gray-scott
export PATH="$PWD/build/bin:$PATH"
jarvis ppl run yaml pipelines/gray-scott.yaml
```

This **automatically**:
1. Loads the pipeline from YAML
2. Configures packages (generates config files)
3. Runs gray-scott simulation

**Note**: You must export PATH before running because Jarvis doesn't propagate the YAML environment section to subprocess execution contexts.

Output: `/workspace/external/iowarp-gray-scott/gs-output.bp`

### Option 2: Step-by-Step (For Debugging/Inspection)

**Step 1: Set PATH**
```bash
cd /workspace/external/iowarp-gray-scott
export PATH="$PWD/build/bin:$PATH"
```

**Step 2: Load Pipeline**
```bash
jarvis ppl load yaml pipelines/gray-scott.yaml
```

This automatically:
- Loads the pipeline configuration
- Runs the configure step (generates settings-files.json and adios2.xml)

Generated files:
- `~/.ppi-jarvis/shared/gray-scott-workflow/builtin.adios2_gray_scott/settings-files.json`
- `~/.ppi-jarvis/shared/gray-scott-workflow/builtin.adios2_gray_scott/adios2.xml`

**Step 3: Run Producer**
```bash
jarvis ppl start
```

### Run Consumer (PDF_Calc)

After the producer completes, analyze the data:

```bash
cd /workspace/external/iowarp-gray-scott
mpirun -n 2 ./build/bin/pdf_calc \
  gs-output.bp \
  pdf-output.bp \
  100
```

Output: `/workspace/external/iowarp-gray-scott/pdf-output.bp`

### 5. Check Status

```bash
# Check pipeline status
jarvis ppl status

# View gray-scott output
ls -lh gs-output.bp/

# View pdf_calc output
ls -lh pdf-output.bp/
```

### 6. Clean Data

```bash
# Clean Jarvis metadata
jarvis ppl clean

# Clean local output files
rm -rf gs-output.bp pdf-output.bp metadata.db ckpt.bp
```

---

## Pipeline Configuration

The pipeline is configured via `gray-scott.yaml` with the following key parameters:

| Parameter | Value | Description |
|-----------|-------|-------------|
| `L` | 64 | Grid size (64×64×64 cube) |
| `nprocs` | 2 | Number of MPI processes |
| `steps` | 100 | Total simulation steps |
| `plotgap` | 5 | Output frequency (every 5 steps) |
| `engine` | bp5 | ADIOS2 engine (bp5, hermes, iowarp, sst) |
| `out_file` | `/workspace/.../gs-output.bp` | Output location |
| `full_run` | false | Don't run postprocessing automatically |

### Chemical Reaction Parameters

| Parameter | Value | Description |
|-----------|-------|-------------|
| `Du` | 0.2 | Diffusion rate of substance U |
| `Dv` | 0.1 | Diffusion rate of substance V |
| `F` | 0.01 | Feed rate of U |
| `k` | 0.05 | Kill rate of V |

---

## Customization

### Method 1: Edit YAML File (Recommended)

Edit `pipelines/gray-scott.yaml` to change parameters:

```yaml
pkgs:
  - pkg_type: builtin.adios2_gray_scott
    L: 128              # Change grid size
    nprocs: 4           # Change MPI processes
    steps: 500          # Change simulation steps
    plotgap: 20         # Change output frequency
    engine: iowarp      # Change ADIOS2 engine
```

Then reload:
```bash
jarvis ppl load pipelines/gray-scott.yaml
jarvis pkg configure adios2_gray_scott
```

### Method 2: Command Line Override

Override specific parameters without editing YAML:

```bash
jarvis pkg configure adios2_gray_scott --L=128 --nprocs=4 --steps=500
```

---

## Complete Workflow Example

```bash
# 1. Navigate to project directory
cd /workspace/external/iowarp-gray-scott

# 2. Set PATH (required for Jarvis to find gray-scott executable)
export PATH="$PWD/build/bin:$PATH"

# 3. Run gray-scott via Jarvis (loads, configures, and runs)
jarvis ppl run yaml pipelines/gray-scott.yaml

# 4. Run consumer (after producer completes)
mpirun -n 2 ./build/bin/pdf_calc gs-output.bp pdf-output.bp 100

# 5. Check results
ls -lh gs-output.bp/ pdf-output.bp/

# 6. Clean up
jarvis ppl clean
rm -rf gs-output.bp pdf-output.bp metadata.db
```

**That's it!** Just 6 commands total.

---

## Understanding the Workflow

Jarvis uses a **two-phase workflow**:

### Phase 1: Parameter Management (YAML)
- `gray-scott.yaml` stores **abstract parameters** (L, nprocs, steps, etc.)
- These are application-agnostic key-value pairs
- Easy to version control and share

### Phase 2: Configuration Generation (`configure`)
- Package-specific code translates parameters into application configs
- Generates `settings-files.json` and `adios2.xml`
- Allows different applications to have different config formats

**Why separate steps?**
- **Explicit**: You know when config files are regenerated
- **Debuggable**: Can inspect generated files before running
- **Flexible**: Can reconfigure without redefining entire pipeline
- **Safe**: Prevents accidental overwrites

---

## Available ADIOS2 Engines

Change the `engine` parameter in `gray-scott.yaml`:

- **bp5**: BP5 file format (default, fastest)
- **bp5_derived**: BP5 with derived variables
- **hermes**: Hermes I/O middleware
- **hermes_derived**: Hermes with derived variables
- **iowarp**: IOWarp integration
- **iowarp_derived**: IOWarp with derived variables
- **sst**: Sustainable Staging Transport (for real-time streaming)

---

## Troubleshooting

### Error: "gray-scott: command not found"
Make sure to add binaries to PATH before running Jarvis:
```bash
export PATH="$PWD/build/bin:$PATH"
```

The YAML environment section does NOT propagate to subprocess execution contexts.

### Configuration not updating after YAML changes
After editing [gray-scott.yaml](gray-scott.yaml), reload the pipeline:
```bash
jarvis ppl load yaml pipelines/gray-scott.yaml
```

This automatically regenerates the configuration files with your new parameters.

---

## Notes

- Ensure `gray-scott` and `pdf_calc` binaries are built before running
- Output files are stored in the project directory (not Jarvis hidden dirs)
- The YAML file is the source of truth - edit it to change parameters
- Always run `configure` after loading/changing the pipeline
